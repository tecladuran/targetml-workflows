---
title: "Full Targeted Analysis of Tarragona Samples"
subtitle: "Random Forest models with GC-IMS + TGN data."
author: "Tecla Duran Fort"
date: "`r Sys.Date()`"
output:
  github_document:
    toc: true
    toc_depth: 3
    number_sections: true
  pdf_document:
    toc: yes
    toc_depth: 3
    number_sections: yes
  html_document:
    toc: yes
    toc_depth: 3
    number_sections: yes
---

# Set Up 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(ggplot2)
library(pls)
library(plsVarSel)
library(dplyr)
library(pROC)
library(tidyverse)
library(purrr)
library(rprojroot)
library(BiocParallel)
knitr::opts_knit$set(root.dir = rprojroot::find_root(rprojroot::is_git_root))
source("../../load_tools.R")
```

```{r, echo=FALSE}
# PARALLELISATION 
param <- setup_parallelisation()
```
**Random Forest models with GC-IMS + TGN data. PQN normalization implemented**

\newpage

# Load Data

## GCIMS Data

The loaded dataset contains the GCIMS intensity for Anisole and 2-Heptanone in the **patient samples**. The correspondence between the clusters and the analytes can be checked at the [Identification Report](https://github.com/tecladuran/targetml-workflows/blob/main/docs/measurements_tarragona/preprocessing/identification/identification_tgn_urine.md)

```{r}
data_gcims <- readr::read_csv(
  "data/tables/tgn_gcims/tgn_gcims_targeted_patients.csv"
)%>%select(-patient_condition)

knitr::kable(head(data_gcims))
```

## TGN Data

```{r}
data_tgn <- read_csv("data/tables/tgn/targetresults.csv")%>%
  filter(condition!="QC")%>% 
  dplyr::select(-condition, -date)

knitr::kable(head(data_tgn))
```

## Metadata

```{r}
metadata <- read_csv("data/tables/tgn/tgn_metadata.csv")

# data_gcims (gcims) has patient_id column

metadata <- data_gcims %>%
  dplyr::select(patient_id) %>%      
  distinct() %>%                   
  left_join(metadata, by = "patient_id")

patient_condition <- metadata %>% dplyr::select(condition)

knitr::kable(head(metadata))
```


# Preprocessing


## GCIMS Quantification

```{r quantification}
analytes <- c("anisole", "heptanone")

# Reference SU
su<-read_csv("data/calibration_tables/su.csv")

scales<- c(0.562, 0.815)

concentrations <- quantify_gcims(
  ref = su,
  analytes = analytes,
  scales = scales,
  peak_table = data_gcims
)

data_gcims_concentration <- cbind(data_gcims, concentrations)

data_gcims_concentration <- data_gcims_concentration %>% 
                                dplyr::select(-anisole, -heptanone, -SampleID) %>%
                                dplyr::rename(
                                    anisole_gcims = conc_anisole,
                                    heptanone_gcims = conc_heptanone
                                  )

knitr::kable(head(data_gcims_concentration))
```

```{r, echo=FALSE}
saveRDS(
  data_gcims_concentration,
  file = file.path("data/additional_objects", "data_gcims_concentration.rds")
)
```


## TGN Data Imputation

```{r}
# Load data for LOQ (provided)
loq <- read_csv("data/tables/tgn/loq.csv")
head(loq)


set.seed(123)

# Filter analytes by a proportion of data available above a threshold

threshold <- 0.2

pct_available <- data_tgn %>%
  summarise(across(-patient_id, ~ mean(!is.na(.x)) )) %>%
  pivot_longer(everything(), names_to = "compound", values_to = "pct") %>%
  filter(pct > threshold)         

# Imputation 

data_tgn_imputed <- data_tgn %>%
  pivot_longer(
    cols = -patient_id,
    names_to = "compound",
    values_to = "intensity"
  ) %>%
  semi_join(pct_available, by = "compound") %>%   
  left_join(loq, by = c("compound" = "compound")) %>% 
  mutate(
    intensity = ifelse(
      is.na(intensity),
      rnorm(n(), mean = 0, sd = sigma), 
      intensity
    ),
    intensity = pmax(intensity, 0) # For negative values
  ) %>%
  select(patient_id, compound, intensity) %>%
  pivot_wider(names_from = compound, values_from = intensity)

knitr::kable(head(data_tgn_imputed))
```
```{r, echo=FALSE}
saveRDS(
  data_tgn_imputed,
  file = file.path("data/additional_objects", "data_tgn_imputed.rds")
)
```


## Data Merge

```{r}
data <- data_gcims_concentration%>% left_join(data_tgn_imputed, by="patient_id")
knitr::kable(head(data))
```
```{r, echo=FALSE}
# SAVE RDS
data_targeted <- data %>%
  left_join(
    metadata %>% dplyr::select(condition, patient_id),
    by = "patient_id"
  ) %>%
  dplyr::rename(patient_condition = condition) %>%
  dplyr::relocate(patient_condition, .after = patient_id)

saveRDS(
  data_targeted,
  file = file.path("data/additional_objects", "targeted_data.rds")
)
```


## PQN Normalisation


```{r}
ref_spectrum <- data %>%
  dplyr::select(-patient_id) %>%
  summarise(across(everything(), median, na.rm = TRUE)) %>%
  as.numeric()
```

```{r, }
feature_names <- data %>%
  dplyr::select(-patient_id) %>%
  colnames()

df_plot <- data.frame(
  index = seq_along(ref_spectrum),
  analyte  = feature_names,
  value = ref_spectrum
)

ggplot(df_plot, aes(x = analyte, y = value)) +
  geom_point() +
  ggtitle("PQN Reference Spectrum") +
  theme(
    axis.text.x = element_text(
      angle = 20,
      size = 10,
      vjust = 0.5,
      hjust = 1
    )
  )

```

```{r}
df_norm <- data %>%
  mutate(across(-patient_id, as.numeric)) %>%
  rowwise() %>%
  mutate(
    PQN_factor = {
      x <- c_across(-patient_id)
      quotients <- x / ref_spectrum
      quotients <- quotients[is.finite(quotients)]
      median(quotients, na.rm = TRUE)
    }
  ) %>%
  mutate(
    across(-c(patient_id, PQN_factor), ~ .x / PQN_factor)
  ) %>%
  ungroup()

```

```{r}
ggplot(df_norm, aes(x = PQN_factor)) +
  geom_histogram() +
  ggtitle("Distribution of PQN Factor") +
  ylab("Number of samples") +
  scale_y_continuous(breaks = scales::pretty_breaks())
```
## Log Transformation 

```{r, echo=TRUE}
# LOG-TRANSFORM ----
data_log <- df_norm %>% select(-PQN_factor) %>%
  mutate(across(-patient_id, log1p))

knitr::kable(head(data_log))
```

```{r}
data<-data_log
```


# Exploratory Analysis


```{r}
# Simple PCA score plot function
plot_pca <- function(data, labels, levels, colors) {
  
  # Select only cluster columns (numerical features)
  features <- data%>%dplyr::select(-patient_id)
  
  # Run PCA
  pca_res <- prcomp(features, scale. = TRUE)
  
  # Build score dataframe
  scores <- as.data.frame(pca_res$x[, 1:2])   # PC1 + PC2
  scores$label <- factor(labels, levels = levels)
  
  # Simple shapes for the two groups
  shapes <- c(16, 17)   # circle, triangle
  
  # Score plot
  ggplot(scores, aes(PC1, PC2, color = label, shape = label)) +
    geom_point(size = 3, alpha = 0.8) +
    scale_color_manual(values = colors) +
    scale_shape_manual(values = shapes) +
    theme_minimal(base_size = 14) +
    labs(title = "PCA Score Plot", x = "PC1", y = "PC2")
}

```

```{r}
group_labels <- as.matrix(patient_condition)
group_levels <- c("CTRL", "CRC")
group_colors <- c("CTRL" = "#337B9F", "CRC" = "#C83342")

p <- plot_pca(data, group_labels, group_levels, group_colors)

print(p)
```
# Statistical Analysis (Wilcoxon Test)

```{r wilcoxon_tests, echo=FALSE, message=FALSE, warning=FALSE}
compounds <- data %>%
  dplyr::select(where(is.numeric)) %>%
  dplyr::select(-patient_id) %>%
  names()


run_wilcox <- function(df, compound){
  x_ctrl <- df %>% filter(patient_condition == "CTRL") %>% pull(compound)
  x_crc  <- df %>% filter(patient_condition == "CRC")  %>% pull(compound)

  wtest <- wilcox.test(x_ctrl, x_crc, exact = FALSE)

  tibble(
    Compound = compound,
    Median_CTRL = median(x_ctrl, na.rm = TRUE),
    Median_CRC  = median(x_crc, na.rm = TRUE),
    p_Wilcoxon  = wtest$p.value
  )
}

wilcox_results <- map_dfr(compounds, ~run_wilcox(data, .x)) %>%
  mutate(
    p_Wilcoxon_adj = p.adjust(p_Wilcoxon, method = "fdr")
  ) %>%
  arrange(p_Wilcoxon_adj)

knitr::kable(
  wilcox_results,
  digits = 4,
  caption = "Wilcoxon rank-sum test per compound: CRC vs CTRL (FDR-adjusted p-values)"
)
```



# Classification Performance

## Adding Metadata as Predictors

```{r}
# Add Metadata in the predictor matrix
df <- data_log %>%
  left_join(metadata, by = "patient_id")

#Code sex
df <- df %>%
  mutate(
    sex = ifelse(sex == "F", 0, 1)
  )
```

```{r}
# Construct predictor matrix X
# (remove response variable and ID if needed)
X <- df %>%
  select(-patient_id, -condition) 

# Response variable
y <- patient_condition%>% as.matrix()
```




## Evaluation


```{r}
set.seed(123)

rf_res <- rf_nested_cv(
  X = X,
  y = y,
  positive_class = "CRC",
  negative_class = "CTRL",
  outer_folds = 7,
  inner_folds = 6,
  ntree = 500,
  mtry_grid = c(2, 4, 6),
  strat_vars = list(X$sex)
)


```

```{r}
show_results(rf_res, title = "Random Forest Nested CV â€” GC-IMS Classification")
```

